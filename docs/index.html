<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Used IT Equipment Price Tracker</title>
  <style>
    :root {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --header-bg: #1e1e1e;
      --border-color: #444;
      --hover-color: #2c2c2c;
      --link-color: #90caf9;
    }
    
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    
    input { 
      padding: 8px; 
      width: 300px; 
      margin-bottom: 15px; 
      background-color: #2a2a2a;
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 4px;
    }
    
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-bottom: 20px;
    }
    
    th, td { 
      border: 1px solid var(--border-color); 
      padding: 10px; 
      text-align: left; 
    }
    
    th { 
      background-color: var(--header-bg); 
    }
    
    tr:hover {
      background-color: var(--hover-color);
    }
    
    a {
      color: var(--link-color);
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    .info-section {
      margin: 20px 0;
      padding: 15px;
      background-color: #1a1a1a;
      border-radius: 5px;
      border-left: 4px solid #555;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    
    .stat-card {
      background-color: #1e1e1e;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 10px;
      flex: 1;
      min-width: 200px;
      margin-right: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .stat-card h3 {
      margin-top: 0;
      color: #90caf9;
    }
  </style>
</head>
<body>
  <h1>Used IT Equipment Price Tracker</h1>
  
  <div class="info-section">
    <h2>About This Tracker</h2>
    <p>This tool tracks prices of used and refurbished IT equipment from various sources. Data is updated daily to provide the most current market prices.</p>
  </div>
  
  <div class="stats">
    <div class="stat-card">
      <h3>Total Products</h3>
      <p id="totalProducts">Loading...</p>
    </div>
    <div class="stat-card">
      <h3>Brands</h3>
      <p id="uniqueBrands">Loading...</p>
    </div>
    <div class="stat-card">
      <h3>Price Range</h3>
      <p id="priceRange">Loading...</p>
    </div>
    <div class="stat-card">
      <h3>Last Updated</h3>
      <p id="lastUpdated">Loading...</p>
    </div>
  </div>
  
  <input type="text" id="search" placeholder="Search by model or brand..." />

  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Model</th>
        <th>Brand</th>
        <th>Price</th>
        <th>Grade</th>
        <th>Source</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody id="productTable"></tbody>
  </table>

  <script>
    async function loadProducts() {
        try {
            // Generate today's filename in format Refurbed_YYMMDD.json
            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const fileName = `Refurbed_${year}${month}${day}.json`;
            
            // Try to load today's file first
            let response = await fetch(`./${fileName}`);
            
            // If today's file doesn't exist, fall back to products.json
            if (!response.ok) {
                response = await fetch('./products.json');
                if (!response.ok) throw new Error("JSON could not be loaded");
            }
            
            const data = await response.json();

            // Update stats
            updateStats(data, fileName);

            const table = document.getElementById('productTable');
            const searchInput = document.getElementById('search');

            function renderTable(products) {
                table.innerHTML = '';
                products.forEach(p => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.title || ''}</td>
                        <td>${p.model || ''}</td>
                        <td>${p.brand || ''}</td>
                        <td>${p.price || ''} ${p.currency_iso || ''}</td>
                        <td>${p.grade || ''}</td>
                        <td>${p.source || ''}</td>
                        <td><a href="${p.url || '#'}" target="_blank">View</a></td>
                    `;
                    table.appendChild(row);
                });
            }

            function filterData(term) {
                if (!term) return data; // Return all data if search term is empty
                
                term = term.toLowerCase();
                return data.filter(p =>
                    (p.title || '').toLowerCase().includes(term) ||
                    (p.model || '').toLowerCase().includes(term) ||
                    (p.brand || '').toLowerCase().includes(term)
                );
            }

            searchInput.addEventListener('input', () => {
                const filtered = filterData(searchInput.value);
                renderTable(filtered);
            });

            // Initial render with all data
            renderTable(data);
        } catch (err) {
            console.error('Error loading products:', err);
            const table = document.getElementById('productTable');
            table.innerHTML = `<tr><td colspan="7">Error loading data. See console for details.</td></tr>`;
        }
    }

    function updateStats(data, fileName) {
        // Total products
        document.getElementById('totalProducts').textContent = data.length;
        
        // Unique brands
        const brands = [...new Set(data.map(p => p.brand).filter(Boolean))];
        document.getElementById('uniqueBrands').textContent = brands.length;
        
        // Price range
        const prices = data.map(p => parseFloat(p.price)).filter(p => !isNaN(p));
        const min = Math.min(...prices);
        const max = Math.max(...prices);
        const currency = data[0]?.currency_iso || 'EUR';
        document.getElementById('priceRange').textContent = `${min} - ${max} ${currency}`;
        
        // Last updated
        const fileDate = fileName.match(/Refurbed_(\d{2})(\d{2})(\d{2})\.json/);
        let dateStr = 'Unknown';
        if (fileDate) {
            const [_, yy, mm, dd] = fileDate;
            dateStr = `20${yy}-${mm}-${dd}`;
        }
        document.getElementById('lastUpdated').textContent = dateStr;
    }

    // Call the function when page loads
    loadProducts();
  </script>
</body>
</html>
